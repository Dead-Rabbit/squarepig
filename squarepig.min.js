pig={canvas:null,context:null,images:{},audio:{},world:null,mouse:{x:undefined,y:undefined,pressed:!1},offset:[0,0],fps:60,audioChannels:[]},pig.init=function(a){canvas=document.getElementById(a),this.canvas=canvas,this.context=canvas.getContext("2d"),this.world=new pig.World,this.canvas.onmousedown=pig._canvasMouseDown,document.onkeydown=pig.keyDown,document.onkeyup=pig.keyUp,this.canvas.onmousemove=pig.mouseMove,this.canvas.onmouseout=pig.mouseOut;if(document.defaultView&&document.defaultView.getComputedStyle){var b=+document.defaultView.getComputedStyle(canvas,null).paddingLeft||0,c=+document.defaultView.getComputedStyle(canvas,null).paddingTop||0,d=+document.defaultView.getComputedStyle(canvas,null).borderLeftWidth||0,e=+document.defaultView.getComputedStyle(canvas,null).borderTopWidth||0;pig.offset=[b+d,c+e]}pig.canvas.width=pig.canvas.clientWidth,pig.canvas.height=pig.canvas.clientHeight,this.camera={x:0,y:0}},pig.imageError=function(a){alert("Could not load "+a+".")},pig.loadImage=function(a){if(a in this.images)return this.images[a];var b=new Image;return b.src=a,b.onload=function(){b.valid=!0},b.onerror=function(){b.valid=!1,pig.imageError(b.src)},this.images[a]=b,b},pig.loadAudio=function(a){var b=null;for(var c=0;c<this.audioChannels.length;++c){b=this.audioChannels[c];if(b.ended)return b.pause(),b.currentTime=0,b.src=a,b}return b=new Audio(a),this.audioChannels.push(b),b},pig._mousePosition=function(a){var b=0,c=0,d=pig.canvas;if(d.offsetParent)do b+=d.offsetLeft,c+=d.offsetTop;while(d=d.parent);var e=[a.pageX-b+pig.offset[0],a.pageY-c+pig.offset[1]];return e},pig._canvasMouseDown=function(a){a.preventDefault(),pig.mouseDown()},pig.keyDown=function(a){pig.world.keyDown(a.keyCode)},pig.keyUp=function(a){pig.world.keyUp(a.keyCode)},pig.mouseDown=function(){pig.world.mouseDown(),pig.mouse.pressed=!0},pig.mouseMove=function(a){var b=pig._mousePosition(a);pig.mouse.x=b[0],pig.mouse.y=b[1]},pig.mouseOut=function(a){pig.mouse.x=undefined,pig.mouse.y=undefined},pig.playSfx=function(a){(new pig.Sfx(a)).play()},pig.run=function(){var a=1e3/pig.fps;pig.time=Date.now(),setInterval(pig.update,a)},pig.setBackground=function(a){pig.canvas.style.backgroundImage="url("+a+")",pig.context.clearRect(0,0,pig.canvas.width,pig.canvas.height)},pig.update=function(){var a=(Date.now()-pig.time)/1e3;pig.time=Date.now(),pig.world.update(a),pig.world.draw(),pig.mouse.pressed=!1},pig.Object=function(){this.clone=function(){var a=function(){};a.prototype=this;var b=new a;return b},this.extend=function(a){var b=this.clone();for(var c in a)b[c]=a[c];return b}},pig.World=function(){pig.Object.apply(this),this.entities=[],this.removed=[],this.maxID=0,this.add=function(a){this.entities.push(a),a.id=this.maxID++,a.world=this,a.added()},this.draw=function(){this.entities.sort(function(a,b){return a.graphic?b.graphic?a.graphic.z==b.graphic.z?a.id-b.id:a.graphic.z-b.graphic.z:1:-1});for(var a=0;a<this.entities.length;++a)this.entities[a].draw()},this.filter=function(a){l=[];for(var b=0;b<this.entities.length;++b)a(this.entities[b])&&l.push(this.entities[b]);return l},this.getType=function(a){return this.filter(function(b){return b.type==a})},this.keyDown=function(a){for(var b=this.entities.length-1;b>=0;--b)if(this.entities[b].keyDown(a))return},this.keyUp=function(a){for(var b=this.entities.length-1;b>=0;--b)if(this.entities[b].keyUp(a))return},this.mouseDown=function(){for(var a=this.entities.length-1;a>=0;--a)if(this.entities[a].mouseDown())return},this.remove=function(a){a.removed(),this.removed.push(a)},this._update=function(a){for(var b=0;b<this.entities.length;++b)this.entities[b].graphic&&this.entities[b].graphic.update(a),this.entities[b].update(a);for(var c=0;c<this.removed.length;++c)for(var b=0;b<this.entities.length;++b)this.entities[b]==this.removed[c]&&this.entities.splice(b,1);this.removed=[]},this.update=function(a){this._update(a)}},pig.Entity=function(){pig.Object.apply(this),this.graphic=null,this.type="entity",this.world=null,this.added=function(){},this.collide=function(a){return!1},this.draw=function(){this.graphic&&this.graphic.draw()},this.keyDown=function(a){},this.keyUp=function(a){},this.mouseDown=function(){},this.removed=function(){},this.update=function(a){}},pig.Graphic=function(){this.x=0,this.y=0,this.z=0,this.draw=function(){},this.update=function(a){}},pig.Rect=function(a,b,c,d){pig.Object.apply(this),this.x=a,this.y=b,this.w=c,this.h=d,this.bottom=function(){return this.y+this.h},this.collidePoint=function(a){return a[0]>=this.x&&a[0]<this.x+this.w&&a[1]>=this.y&&a[1]<this.y+this.h},this.collideRect=function(a){return this.x>a.x+a.w?!1:a.x>this.x+this.w?!1:this.y>a.y+a.h?!1:a.y>this.y+this.h?!1:!0},this.left=function(){return this.x},this.place=function(a){this.x=a[0],this.y=a[1]},this.right=function(){return this.x+this.w},this.top=function(){return this.y}},pig.Circle=function(a,b,c){pig.Object.apply(this),this.x=a,this.y=b,this.radius=c,this.collideCircle=function(a){var b=this.x-a.x,c=this.y-a.y,d=b*b+c*c,e=this.radius+a.radius,f=d<=e*e;return f},this.collidePoint=function(a){var b=[a[0]-this.x,a[1]-this.y];return b[0]*b[0]+b[1]*b[1]<=this.radius*this.radius},this.place=function(a){this.x=a[0],this.y=a[1]}},pig.Graphiclist=function(a){pig.Graphic.apply(this),this.graphics=a||[],this.draw=function(){pig.context.save(),pig.context.translate(this.x,this.y);for(var a=0;a<this.graphics.length;++a)this.graphics[a].draw();pig.context.restore()},this.pop=function(){this.graphics.pop()},this.push=function(a){this.graphics.push(a)},this.remove=function(a){for(var b=0;b<this.graphics.length;++b)this.graphics[b]==a&&this.graphics.slice(b)},this.shift=function(){this.graphics.shift()},this.unshift=function(a){this.graphics.unshift(a)},this.update=function(a){for(var b=0;b<this.graphics.length;++b)this.graphics[b].update(a)}},pig.Canvas=function(a,b,c,d){pig.Graphic.apply(this),this.x=a,this.y=b,this.w=c,this.h=d,this.alpha=1,this.canvas=document.createElement("canvas"),this.canvas.width=c,this.canvas.height=d,this.context=this.canvas.getContext("2d"),this.draw=function(){pig.context.save(),pig.context.globalAlpha=this.alpha,this.ignoreCamera?pig.context.translate(Math.floor(this.x),Math.floor(this.y)):pig.context.translate(Math.floor(this.x+pig.camera.x),Math.floor(this.y+pig.camera.y)),pig.context.drawImage(this.canvas,0,0),pig.context.restore()},this.update=function(a){pig.context.clearRect(Math.floor(this.x-1),Math.floor(this.y-1),Math.floor(this.width+1),Math.floor(this.width+1))}},pig.Canvas.createRect=function(a,b,c,d,e){var f=new pig.Canvas(a,b,c,d);return f.context.fillStyle=e,f.context.fillRect(0,0,c,d),f},pig.Image=function(a,b,c){pig.Graphic.apply(this),this.x=a,this.y=b,this.alpha=1;if(!c)throw"Image not specified.";this.image=pig.loadImage(c),this.draw=function(){if(!this.image.valid)return;pig.context.save(),pig.context.globalAlpha=this.alpha,this.ignoreCamera?pig.context.translate(Math.floor(this.x),Math.floor(this.y)):pig.context.translate(Math.floor(this.x+pig.camera.x),Math.floor(this.y+pig.camera.y)),pig.context.drawImage(this.image,0,0),pig.context.globalAlpha=1,pig.context.restore()},this.place=function(a){this.x=a[0],this.y=a[1]},this.update=function(a){pig.context.clearRect(Math.floor(this.x-1),Math.floor(this.y-1),Math.round(this.width+1),Math.round(this.height+1)),this.width=this.image.width,this.height=this.image.height}},pig.Sprite=function(a,b,c,d,e){pig.Graphic.apply(this),this.x=a,this.y=b,this.origin=[0,0],this.scale=1,this.image=pig.loadImage(c),this.frame=0,this.animations={},this.animation=null,this.fps=0,this.time=0,this.frameWidth=d,this.frameHeight=e,this.flip=!1,this.alpha=1,this.add=function(a,b){this.animations[a]=b},this.draw=function(){if(this.image.valid){var a=this.x-this.image.width/2*(this.scale-1),b=this.y-this.image.height/2*(this.scale-1),c=0,d=0;if(this.animation){var e=this.animation[this.frame],f=Math.floor(this.image.width/this.frameWidth);c=e%f*this.frameWidth,d=Math.floor(e/f)*this.frameHeight}pig.context.save(),pig.context.globalAlpha=this.alpha,this.ignoreCamera?pig.context.translate(Math.floor(this.x),Math.floor(this.y)):pig.context.translate(Math.floor(this.x+pig.camera.x),Math.floor(this.y+pig.camera.y)),this.flip&&(pig.context.scale(-1,1),pig.context.translate(-this.frameWidth,0)),pig.context.drawImage(this.image,c,d,this.frameWidth,this.frameHeight,0,0,Math.floor(this.frameWidth*this.scale),Math.floor(this.frameHeight*this.scale)),pig.context.globalAlpha=1,pig.context.restore()}},this.place=function(a){this.x=a[0],this.y=a[1]},this.play=function(a,b){this.animation=this.animations[a],this.fps=b,this.frame=0,this.time=0},this.update=function(a){pig.context.clearRect(Math.floor(this.x-1),Math.floor(this.y-1),Math.floor(this.w+1),Math.floor(this.h+1)),this.w=this.image.width,this.h=this.image.height,this.time+=a;if(this.fps>0&&this.time>1/this.fps){++this.frame;while(this.time>1/this.fps)this.time-=1/this.fps;this.frame>=this.animation.length&&(this.frame-=this.animation.length)}}},pig.Tilemap=function(a,b,c,d,e,f,g){pig.Graphic.apply(this),this.x=a,this.y=b,this.gridW=f,this.gridH=g,this.tileW=d,this.tileH=e,this.image=pig.loadImage(c),this.canvas=null,this.build=function(){this.canvas=new pig.Canvas(b,a,d*f,e*g),this.canvas=pig.Canvas.createRect(0,0,d*f,e*g,"white");for(var a=0;a<g;++a)for(var b=0;b<f;++b)this.setTile(b,a,this.tile(b,a))},this.draw=function(){this.canvas&&this.canvas.draw()},this.tile=function(a,b){return a<0||b<0||a>=this.gridW||b>=this.gridH?undefined:this.tiles[b*this.gridW+a]},this.setTile=function(a,b,c){if(a<0||b<0||a>=this.gridW||b>=this.gridH)return;this.tiles[b*this.gridW+a]=c;if(this.canvas){var d=c*this.tileW,e=0,f=a*this.tileW,g=b*this.tileH;this.canvas.context.clearRect(f,g,this.tileW,this.tileH),this.canvas.context.drawImage(this.image,d,e,this.tileW,this.tileH,f,g,this.tileW,this.tileH)}},this.tiles=[];for(var b=0;b<g;++b)for(var a=0;a<f;++a)this.tiles.push(0);this.update=function(a){pig.context.clearRect(Math.floor(this.x-1),Math.floor(this.y-1),Math.floor(this.width+1),Math.floor(this.width+1)),!this.canvas&&this.image.valid&&this.build()}},pig.Text=function(a,b,c,d,e,f){pig.Graphic.apply(this),this.x=a,this.y=b,this.text=c,this.font=d||"sans",this.colour=e||"white",this.size=f||14,pig.context.textBaseline="top",pig.context.font=this.size+"px "+this.font,pig.context.fillStyle=this.colour,this.width=pig.context.measureText(c).width,this.height=this.size,this.draw=function(){this.width=pig.context.measureText(this.text),pig.context.textBaseline="top",pig.context.font=this.size+"px "+this.font,pig.context.fillStyle=this.colour,pig.context.fillText(this.text,this.x,this.y)},this.update=function(){pig.context.clearRect(Math.floor(this.x-1),Math.floor(this.y-1),Math.floor(this.width+1),Math.floor(this.width+1))}},pig.Sfx=function(a){pig.Object.apply(this),this.play=function(){this.sound=pig.loadAudio(a),this.sound.play()}},pig.key={A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,ZERO:48,ONE:49,TWO:50,THREE:51,FOUR:52,FIVE:53,SIX:54,SEVEN:55,EIGHT:56,NINE:57,LEFT:37,UP:38,RIGHT:39,DOWN:40},pig.version=.2